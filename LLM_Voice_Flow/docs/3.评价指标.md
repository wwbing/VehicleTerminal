# 智能座舱意图识别与指令转换评估指标

## 简介

本文档提供了专门针对智能座舱意图识别和指令转换任务的评估方法。与传统的文本生成任务不同，该任务需要评估结构化输出的准确性，包括意图分类和指令转换两个维度。

## 任务特点

智能座舱的意图识别任务具有以下特点：
- **结构化输出**：格式为 `【意图】###【指令】`
- **有限意图集合**：意图需要在预定义的9个类别中选择
- **准确性要求高**：意图识别错误会导致完全错误的系统响应
- **指令简洁性**：要求输出简洁明确的指令

## 评估指标体系

### 1. 意图分类准确率（Intent Classification Accuracy）

这是最重要的指标，评估模型是否能正确识别用户意图。

```python
def intent_accuracy(predictions, labels):
    """计算意图分类准确率"""
    correct = 0
    total = len(predictions)

    for pred, label in zip(predictions, labels):
        try:
            pred_intent = pred.split('###')[0].strip()
            label_intent = label.split('###')[0].strip()
            if pred_intent == label_intent:
                correct += 1
        except:
            # 格式错误的预测视为错误
            pass

    return correct / total * 100
```

### 2. 完全匹配准确率（Exact Match Accuracy）

评估整个输出（意图+指令）是否完全正确。

```python
def exact_match_accuracy(predictions, labels):
    """计算完全匹配准确率"""
    correct = 0
    total = len(predictions)

    for pred, label in zip(predictions, labels):
        if pred.strip() == label.strip():
            correct += 1

    return correct / total * 100
```

### 3. 指令相似度准确率（Command Similarity Accuracy）

使用字符级相似度评估指令部分的准确性（在意图正确的前提下）。

```python
def command_similarity_accuracy(predictions, labels, threshold=0.6):
    """计算指令相似度准确率"""
    import jieba

    def calculate_similarity(str1, str2):
        """计算两个字符串的相似度"""
        # 使用字符级别的Jaccard相似度
        set1 = set(str1)
        set2 = set(str2)

        if len(set1) == 0 and len(set2) == 0:
            return 1.0

        intersection = len(set1.intersection(set2))
        union = len(set1.union(set2))

        return intersection / union if union > 0 else 0.0

    similarities = []
    valid_pairs = 0

    for pred, label in zip(predictions, labels):
        try:
            pred_parts = pred.split('###')
            label_parts = label.split('###')

            if len(pred_parts) == 2 and len(label_parts) == 2:
                pred_intent, pred_command = pred_parts[0].strip(), pred_parts[1].strip()
                label_intent, label_command = label_parts[0].strip(), label_parts[1].strip()

                # 只在意图正确的情况下评估指令相似度
                if pred_intent == label_intent:
                    valid_pairs += 1
                    similarity = calculate_similarity(pred_command, label_command)
                    similarities.append(similarity)
        except:
            pass

    if not similarities:
        return 0.0, 0.0

    # 计算平均相似度
    avg_similarity = sum(similarities) / len(similarities)

    # 计算超过阈值的比例
    above_threshold = sum(1 for sim in similarities if sim >= threshold) / len(similarities)

    return avg_similarity * 100, above_threshold * 100


def command_exact_accuracy(predictions, labels):
    """计算指令完全匹配准确率（作为对比）"""
    correct = 0
    valid_pairs = 0

    for pred, label in zip(predictions, labels):
        try:
            pred_parts = pred.split('###')
            label_parts = label.split('###')

            if len(pred_parts) == 2 and len(label_parts) == 2:
                pred_intent, pred_command = pred_parts[0].strip(), pred_parts[1].strip()
                label_intent, label_command = label_parts[0].strip(), label_parts[1].strip()

                # 只在意图正确的情况下评估指令
                if pred_intent == label_intent:
                    valid_pairs += 1
                    if pred_command == label_command:
                        correct += 1
        except:
            pass

    return correct / valid_pairs * 100 if valid_pairs > 0 else 0
```

### 4. 格式正确率（Format Accuracy）

评估输出是否符合预期格式。

```python
def format_accuracy(predictions):
    """计算格式正确率"""
    correct_format = 0
    total = len(predictions)

    valid_intents = ['温湿度显示', '时间显示', '音乐播放', '音量控制',
                    '地图导航', '倒车监控', '天气查询', '通用指令', '拒识']

    for pred in predictions:
        try:
            parts = pred.split('###')
            if len(parts) == 2:
                intent = parts[0].strip()
                command = parts[1].strip()

                # 检查意图是否在有效集合中，指令是否非空
                if intent in valid_intents and len(command) > 0:
                    correct_format += 1
        except:
            pass

    return correct_format / total * 100
```

### 5. 综合评估函数

```python
def evaluate_intent_command_model(predictions, labels, similarity_threshold=0.6):
    """综合评估意图识别和指令转换模型"""
    results = {}

    # 1. 意图分类准确率（最重要）
    results['intent_accuracy'] = intent_accuracy(predictions, labels)

    # 2. 指令相似度准确率
    avg_similarity, above_threshold = command_similarity_accuracy(predictions, labels, similarity_threshold)
    results['command_avg_similarity'] = avg_similarity
    results['command_similarity_accuracy'] = above_threshold

    # 3. 指令完全匹配准确率（作为对比）
    results['command_exact_accuracy'] = command_exact_accuracy(predictions, labels)

    # 4. 格式正确率
    results['format_accuracy'] = format_accuracy(predictions)

    # 5. 分层统计
    intent_correct = 0
    format_correct = 0
    total = len(predictions)

    valid_intents = ['温湿度显示', '时间显示', '音乐播放', '音量控制',
                    '地图导航', '倒车监控', '天气查询', '通用指令', '拒识']

    # 指令相似度统计
    similarities = []
    command_pairs = []

    for pred, label in zip(predictions, labels):
        try:
            pred_parts = pred.split('###')
            label_parts = label.split('###')

            if len(pred_parts) == 2 and len(label_parts) == 2:
                pred_intent, pred_command = pred_parts[0].strip(), pred_parts[1].strip()
                label_intent, label_command = label_parts[0].strip(), label_parts[1].strip()

                # 格式检查
                if pred_intent in valid_intents and len(pred_command) > 0:
                    format_correct += 1

                # 意图检查
                if pred_intent == label_intent:
                    intent_correct += 1

                    # 计算指令相似度
                    def calculate_similarity(str1, str2):
                        set1 = set(str1)
                        set2 = set(str2)
                        if len(set1) == 0 and len(set2) == 0:
                            return 1.0
                        intersection = len(set1.intersection(set2))
                        union = len(set1.union(set2))
                        return intersection / union if union > 0 else 0.0

                    similarity = calculate_similarity(pred_command, label_command)
                    similarities.append(similarity)
                    command_pairs.append((pred_command, label_command, similarity))
        except:
            pass

    results['detailed_stats'] = {
        'intent_correct': intent_correct,
        'format_correct': format_correct,
        'total': total,
        'command_similarities': similarities,
        'command_pairs': command_pairs
    }

    return results
```

## 实际评估示例

### 测试数据

```python
# 测试样例
test_cases = [
    {
        "prediction": "温湿度显示###显示车内温度",
        "label": "温湿度显示###显示车内温度"
    },
    {
        "prediction": "时间显示###显示当前时间",
        "label": "时间显示###显示时间"
    },
    {
        "prediction": "音乐播放###播放音乐",
        "label": "音乐播放###播放音乐"
    },
    {
        "prediction": "地图导航###打开导航功能",
        "label": "地图导航###显示导航界面"
    },
    {
        "prediction": "天气查询###查询今天天气",
        "label": "天气查询###查询今天天气"
    },
    {
        "prediction": "格式错误的输出",
        "label": "拒识###无法识别指令"
    }
]

predictions = [case["prediction"] for case in test_cases]
labels = [case["label"] for case in test_cases]
```

### 计算结果

```python
# 执行评估
results = evaluate_intent_command_model(predictions, labels, similarity_threshold=0.6)

print("=== 智能座舱意图识别评估结果 ===")
print(f"意图分类准确率: {results['intent_accuracy']:.2f}%")
print(f"指令平均相似度: {results['command_avg_similarity']:.2f}%")
print(f"指令相似度准确率(>60%): {results['command_similarity_accuracy']:.2f}%")
print(f"指令完全匹配准确率: {results['command_exact_accuracy']:.2f}%")
print(f"格式正确率: {results['format_accuracy']:.2f}%")

print("\n=== 详细统计 ===")
stats = results['detailed_stats']
print(f"总样本数: {stats['total']}")
print(f"意图正确数: {stats['intent_correct']}")
print(f"格式正确数: {stats['format_correct']}")

print("\n=== 指令相似度分析 ===")
for i, (pred_cmd, label_cmd, similarity) in enumerate(stats['command_pairs']):
    print(f"样例{i+1}: 相似度 {similarity:.2f}")
    print(f"  预测指令: {pred_cmd}")
    print(f"  标准指令: {label_cmd}")
```

### 预期输出结果

```
=== 智能座舱意图识别评估结果 ===
意图分类准确率: 83.33%
指令平均相似度: 78.40%
指令相似度准确率(>60%): 80.00%
指令完全匹配准确率: 60.00%
格式正确率: 83.33%

=== 详细统计 ===
总样本数: 6
意图正确数: 5
格式正确数: 5

=== 指令相似度分析 ===
样例1: 相似度 1.00
  预测指令: 显示车内温度
  标准指令: 显示车内温度

样例2: 相似度 0.67
  预测指令: 显示当前时间
  标准指令: 显示时间

样例3: 相似度 1.00
  预测指令: 播放音乐
  标准指令: 播放音乐

样例4: 相似度 0.67
  预测指令: 打开导航功能
  标准指令: 显示导航界面

样例5: 相似度 1.00
  预测指令: 查询今天天气
  标准指令: 查询今天天气
```

### 结果分析

**样例分析：**

1. **样例1**: `温湿度显示###显示车内温度` vs `温湿度显示###显示车内温度`
   - ✅ 意图正确、✅ 指令完全匹配(相似度1.00)、✅ 格式正确

2. **样例2**: `时间显示###显示当前时间` vs `时间显示###显示时间`
   - ✅ 意图正确、⚠️ 指令相似度0.67(部分匹配)、✅ 格式正确

3. **样例3**: `音乐播放###播放音乐` vs `音乐播放###播放音乐`
   - ✅ 意图正确、✅ 指令完全匹配(相似度1.00)、✅ 格式正确

4. **样例4**: `地图导航###打开导航功能` vs `地图导航###显示导航界面`
   - ✅ 意图正确、⚠️ 指令相似度0.67(语义相近)、✅ 格式正确

5. **样例5**: `天气查询###查询今天天气` vs `天气查询###查询今天天气`
   - ✅ 意图正确、✅ 指令完全匹配(相似度1.00)、✅ 格式正确

6. **样例6**: `格式错误的输出` vs `拒识###无法识别指令`
   - ❌ 意图错误、❌ 指令无法评估、❌ 格式错误

**相似度计算示例：**
- "显示当前时间" vs "显示时间": 字符集合相似度 = 4/6 = 0.67
- "打开导航功能" vs "显示导航界面": 字符集合相似度 = 4/6 = 0.67

## 评估指标权重建议

根据智能座舱应用的实际需求，调整后的权重分配：

| 指标 | 权重 | 重要性说明 |
|------|------|------------|
| 意图分类准确率 | 50% | 最关键，意图错误会导致完全错误的响应 |
| 指令相似度准确率 | 30% | 评估指令语义的准确性，允许合理的表达差异 |
| 格式正确率 | 20% | 确保输出可被系统正确解析 |

**综合评分公式：**
```
综合得分 = 意图准确率 × 0.5 + 指令相似度准确率 × 0.3 + 格式正确率 × 0.2
```

**相似度阈值建议：**
- 0.8以上：高质量匹配
- 0.6-0.8：可接受匹配
- 0.6以下：需要改进

## 使用建议

1. **优先关注意图分类准确率**：这是最核心的指标，直接影响系统响应的正确性
2. **重视指令相似度评估**：比完全匹配更灵活，能识别语义相近的表达
3. **监控格式正确率**：确保输出能被下游系统正确解析
4. **设置合理的相似度阈值**：根据业务需求调整阈值(建议0.6-0.8)
5. **针对错误案例进行分析**：重点关注意图分类错误和低相似度的样本

## 与传统NLG指标的对比

| 指标类型 | 适用场景 | 优势 | 劣势 |
|----------|----------|------|------|
| BLEU/ROUGE | 自由文本生成 | 评估流畅性和n-gram重叠 | 不适合结构化输出，忽略语义 |
| 意图分类准确率 | 结构化任务 | 直接反映核心任务性能 | 不评估指令质量 |
| 指令相似度 | 指令评估 | 考虑语义相似性，更灵活 | 需要合理设置阈值 |
| 格式正确率 | 结构化输出 | 确保系统可解析性 | 不评估内容质量 |

## 实际应用建议

**模型优化方向：**
1. 当意图准确率低时：增强意图分类训练数据，优化prompt设计
2. 当指令相似度低时：丰富指令表达的训练样本，提高指令生成质量
3. 当格式错误率高时：强化输出格式约束，增加格式检查机制

**评估频率：**
- 开发阶段：每次模型更新后进行全面评估
- 生产阶段：定期抽样评估，监控性能退化
- 问题排查：针对用户反馈的错误案例进行专项评估

对于智能座舱这类结构化输出任务，本文档提出的评估体系比传统BLEU/ROUGE指标更适合，能更准确地反映模型在实际应用中的表现。