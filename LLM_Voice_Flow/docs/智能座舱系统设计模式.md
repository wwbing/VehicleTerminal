# 智能座舱系统设计模式

## 目录
- [设计模式概述](#设计模式概述)
- [推荐架构：命令模式 + 策略模式](#推荐架构命令模式--策略模式)
- [数据结构设计](#数据结构设计)
- [系统架构图](#系统架构图)
- [代码实现示例](#代码实现示例)
- [训练数据格式优化](#训练数据格式优化)

## 设计模式概述

### 核心问题
智能座舱系统需要：
1. 理解用户自然语言输入
2. 转换为具体的操作指令
3. 调用相应的业务功能
4. 返回用户友好的响应

### 推荐方案
采用 **Command Pattern + Strategy Pattern** 的组合架构，配合结构化的输出格式。

## 推荐架构：命令模式 + 策略模式

### 1. 命令模式（Command Pattern）
- **作用**：将用户意图封装为具体的命令对象
- **优势**：解耦请求发送者和接收者，支持命令队列、撤销、重做等高级功能

### 2. 策略模式（Strategy Pattern）
- **作用**：为不同类型的操作提供不同的执行策略
- **优势**：易于扩展新功能，便于测试和维护

### 3. 组合优势
- 清晰的职责分离
- 高度可扩展性
- 易于测试和维护
- 支持复杂的业务逻辑

## 数据结构设计

### 优化后的训练数据格式
```json
{
  "instruction": "音乐播放",
  "input": "用户说：播放周杰伦的夜曲",
  "output": {
    "action": "MUSIC_PLAY",
    "parameters": {
      "song": "夜曲",
      "artist": "周杰伦",
      "album": "十一月的萧邦",
      "source": "user_request"
    },
    "response": "正在为您播放音乐。当前播放：《夜曲》，来自周杰伦的专辑《十一月的萧邦》。",
    "confidence": 0.95,
    "requires_confirmation": false
  }
}
```

### 操作类型定义
```json
{
  "MUSIC_PLAY": "音乐播放",
  "MUSIC_PAUSE": "音乐暂停",
  "MUSIC_NEXT": "下一首",
  "MUSIC_PREV": "上一首",
  "MUSIC_VOLUME_UP": "音量调大",
  "MUSIC_VOLUME_DOWN": "音量调小",
  "MUSIC_SEARCH": "音乐搜索",
  "MUSIC_DOWNLOAD": "音乐下载",
  "NAVIGATION_START": "开始导航",
  "NAVIGATION_STOP": "停止导航",
  "NAVIGATION_REROUTE": "重新规划路线",
  "MAP_DISPLAY": "显示地图",
  "MAP_ZOOM_IN": "放大地图",
  "MAP_ZOOM_OUT": "缩小地图",
  "REVERSE_CAMERA": "倒车影像",
  "VEHICLE_STATUS": "车辆状态查询",
  "CLIMATE_CONTROL": "空调控制",
  "LIGHTING_CONTROL": "灯光控制",
  "EMERGENCY_CALL": "紧急呼叫",
  "VOICE_ASSISTANT": "语音助手"
}
```

## 系统架构图

```
用户输入 → 大模型理解 → 结构化输出 → 命令解析器 → 策略执行器 → 业务功能 → 响应生成
    ↓           ↓           ↓           ↓           ↓           ↓           ↓
自然语言   意图识别    操作描述    命令对象    具体策略    系统调用    用户反馈
```

### 详细流程
1. **用户输入**：自然语言指令
2. **大模型理解**：转换为结构化操作描述
3. **命令解析器**：根据action类型创建对应的Command对象
4. **策略执行器**：根据Command类型选择相应的Strategy
5. **业务功能**：执行具体的系统操作
6. **响应生成**：返回用户友好的反馈

## 代码实现示例

### 1. 命令接口
```cpp
class ICommand {
public:
    virtual ~ICommand() = default;
    virtual void execute() = 0;
    virtual void undo() = 0;
    virtual std::string getResponse() const = 0;
};
```

### 2. 具体命令实现
```cpp
class MusicPlayCommand : public ICommand {
private:
    MusicParameters params_;
    IMusicStrategy* strategy_;
    
public:
    MusicPlayCommand(const MusicParameters& params, IMusicStrategy* strategy)
        : params_(params), strategy_(strategy) {}
    
    void execute() override {
        strategy_->playMusic(params_);
    }
    
    void undo() override {
        strategy_->pauseMusic();
    }
    
    std::string getResponse() const override {
        return "正在为您播放音乐。当前播放：《" + params_.song + 
               "》，来自" + params_.artist + "的专辑《" + params_.album + "》。";
    }
};
```

### 3. 策略接口
```cpp
class IMusicStrategy {
public:
    virtual ~IMusicStrategy() = default;
    virtual void playMusic(const MusicParameters& params) = 0;
    virtual void pauseMusic() = 0;
    virtual void nextSong() = 0;
    virtual void prevSong() = 0;
    virtual void setVolume(int volume) = 0;
};
```

### 4. 命令工厂
```cpp
class CommandFactory {
public:
    static std::unique_ptr<ICommand> createCommand(
        const std::string& action,
        const nlohmann::json& parameters
    ) {
        if (action == "MUSIC_PLAY") {
            MusicParameters params = parseMusicParams(parameters);
            return std::make_unique<MusicPlayCommand>(params, getMusicStrategy());
        }
        // 其他命令类型...
        throw std::runtime_error("Unknown action: " + action);
    }
};
```

### 5. 主控制器
```cpp
class VoiceController {
private:
    std::unique_ptr<LLMModel> llm_;
    CommandFactory factory_;
    
public:
    std::string processUserInput(const std::string& input) {
        // 1. 大模型理解
        auto structuredOutput = llm_->process(input);
        
        // 2. 创建命令
        auto command = factory_.createCommand(
            structuredOutput["action"],
            structuredOutput["parameters"]
        );
        
        // 3. 执行命令
        command->execute();
        
        // 4. 返回响应
        return command->getResponse();
    }
};
```

## 训练数据格式优化

### 优化后的数据集示例

#### 音乐播放场景
```json
[
  {
    "instruction": "音乐播放",
    "input": "用户说：播放周杰伦的夜曲",
    "output": {
      "action": "MUSIC_PLAY",
      "parameters": {
        "song": "夜曲",
        "artist": "周杰伦",
        "album": "十一月的萧邦",
        "source": "user_request"
      },
      "response": "正在为您播放音乐。当前播放：《夜曲》，来自周杰伦的专辑《十一月的萧邦》。",
      "confidence": 0.95,
      "requires_confirmation": false
    }
  },
  {
    "instruction": "音乐控制",
    "input": "用户说：暂停音乐",
    "output": {
      "action": "MUSIC_PAUSE",
      "parameters": {},
      "response": "音乐已暂停。您可以随时说'继续播放'来恢复音乐。",
      "confidence": 0.98,
      "requires_confirmation": false
    }
  },
  {
    "instruction": "音乐搜索",
    "input": "用户说：搜索周杰伦的歌",
    "output": {
      "action": "MUSIC_SEARCH",
      "parameters": {
        "query": "周杰伦",
        "type": "artist"
      },
      "response": "正在搜索周杰伦的歌曲。找到以下歌曲：1.《稻香》；2.《青花瓷》；3.《夜曲》；4.《晴天》；5.《七里香》。您想播放哪一首？",
      "confidence": 0.92,
      "requires_confirmation": true
    }
  }
]
```

#### 导航场景
```json
[
  {
    "instruction": "导航服务",
    "input": "用户说：导航到北京天安门",
    "output": {
      "action": "NAVIGATION_START",
      "parameters": {
        "destination": "北京天安门",
        "route_type": "fastest"
      },
      "response": "正在为您规划到北京天安门的路线。预计行驶时间45分钟，距离25公里。",
      "confidence": 0.94,
      "requires_confirmation": true
    }
  },
  {
    "instruction": "地图控制",
    "input": "用户说：放大地图",
    "output": {
      "action": "MAP_ZOOM_IN",
      "parameters": {
        "zoom_level": "increase"
      },
      "response": "正在放大地图。地图已放大，现在可以看到更详细的街道信息。",
      "confidence": 0.97,
      "requires_confirmation": false
    }
  }
]
```

#### 车辆控制场景
```json
[
  {
    "instruction": "倒车辅助",
    "input": "用户说：显示倒车影像",
    "output": {
      "action": "REVERSE_CAMERA",
      "parameters": {
        "camera_type": "rear",
        "display_mode": "full_screen"
      },
      "response": "正在显示倒车影像。后视摄像头已激活，请观察屏幕上的倒车影像。",
      "confidence": 0.96,
      "requires_confirmation": false
    }
  },
  {
    "instruction": "车辆状态",
    "input": "用户说：检查车辆状态",
    "output": {
      "action": "VEHICLE_STATUS",
      "parameters": {
        "check_items": ["fuel", "tire_pressure", "engine", "battery"]
      },
      "response": "正在检查车辆状态。燃油剩余65%，胎压正常，发动机运行良好，电池电量充足。",
      "confidence": 0.93,
      "requires_confirmation": false
    }
  }
]
```

## 优势总结

### 1. 开发效率
- 新增功能只需添加新的Command和Strategy
- 无需修改现有代码，符合开闭原则

### 2. 维护性
- 清晰的代码结构，易于理解和维护
- 每个组件职责单一，便于测试

### 3. 扩展性
- 支持复杂的业务逻辑
- 易于集成新的AI模型或业务功能

### 4. 用户体验
- 保持自然语言交互
- 提供结构化的操作反馈

### 5. 系统稳定性
- 错误处理更加可控
- 支持操作撤销和重做
- 便于日志记录和调试

这种设计模式特别适合智能座舱这种需要处理多种复杂交互场景的系统，既保证了系统的可维护性，又提供了良好的用户体验。 